name: Monitor CA Rural Health Page

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      URL: "https://hcai.ca.gov/workforce/health-workforce/california-state-office-of-rural-health/"
      UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch and Wrap Page
        run: |
          if curl -sL -A "${UA}" "https://r.jina.ai/${URL}" > raw.txt; then
            echo "FETCH_OK=true" >> "$GITHUB_ENV"
            cat raw.txt | sed -E 's/<script[^>]*>.*<\/script>//gI; s/<style[^>]*>.*<\/style>//gI; s/<[^>]*>//g' | tr -s '[:space:]' ' ' | fmt -w 80 > CApage_current.txt
          else
            echo "FETCH_OK=false" >> "$GITHUB_ENV"
          fi

      - name: Compare and Heartbeat
        run: |
          echo "Last checked: $(date -u)" > CAheartbeat.txt
          [ -f CApage_previous.txt ] && prev=$(sha256sum CApage_previous.txt | cut -d' ' -f1) || prev="none"
          curr=$(sha256sum CApage_current.txt | cut -d' ' -f1)
          if [ "$curr" != "$prev" ]; then echo "CHANGED=true" >> "$GITHUB_ENV"; mv CApage_current.txt CApage_previous.txt; else echo "CHANGED=false" >> "$GITHUB_ENV"; fi

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add CAheartbeat.txt
          if [ "${FETCH_OK}" = "true" ] && [ "${CHANGED}" = "true" ]; then git add CApage_previous.txt && git commit -m "ALARM: CA Content Change"; else git commit -m "CA RHT: Heartbeat"; fi
          git pull --rebase origin main
          git push
