name: Monitor CA Rural Health Transformation Page

on:
  schedule:
    - cron: "0 * * * *"   # Runs hourly
  workflow_dispatch:      # Manual trigger for testing

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      URL: "https://hcai.ca.gov/workforce/health-workforce/california-state-office-of-rural-health/"
      UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Page (multi-mirror, headers & retry)
        id: fetch
        shell: bash
        run: |
          set -euo pipefail

          # Mirrors in order of preference:
          # 1) Jina Reader (renders readable text & bypasses many JS/cookie walls)
          # 2) Textise (alternate IP + stripped text view)
          MIRRORS=(
            "https://r.jina.ai/${URL}"
            "https://www.textise.org/showtext.aspx?strURL=${URL}"
          )

          # Helper to decide if content is blocked
          is_blocked() {
            grep -qiE "Access Denied|403 Forbidden|Security Service|Please enable cookies|unusual traffic|blocked|You don't have permission|not authorized" "$1"
          }

          FETCH_OK=false
          > raw.txt || true

          for MIRROR in "${MIRRORS[@]}"; do
            echo "Attempting mirror: ${MIRROR}"

            # Use browser-like headers and robust retry/backoff
            if ! curl -sL \
              --fail \
              --retry 3 \
              --retry-delay 5 \
              --connect-timeout 10 \
              --max-time 45 \
              -A "${UA}" \
              -H "Accept-Language: en-US,en;q=0.9" \
              -H "Referer: https://www.google.com/" \
              --compressed \
              "${MIRROR}" > raw.txt; then
              echo "curl failed for ${MIRROR}, trying next mirror..."
              continue
            fi

            if is_blocked raw.txt; then
              echo "Content indicates access denied for ${MIRROR}, trying next mirror..."
              continue
            fi

            # If we got here, fetch succeeded and is not blocked
            FETCH_OK=true
            break
          done

          # If everything failed: write a sentinel file so downstream steps proceed safely
          if [ "${FETCH_OK}" = "false" ]; then
            echo "FETCH_FAILED: Access Denied or mirrors unavailable at $(date -u) for ${URL}" > CApage_current.txt
            echo "FETCH_OK=false" >> "$GITHUB_ENV"
          else
            echo "FETCH_OK=true" >> "$GITHUB_ENV"
          fi

          # Normalize content (whether text-only or HTML) to produce a stable hash
          cat raw.txt \
            | sed -E 's/<script[^>]*>.*<\/script>//gI' \
            | sed -E 's/<style[^>]*>.*<\/style>//gI' \
            | sed 's/<[^>]*>//g' \
            | sed '/Textise/d' \
            | sed '/Options/d' \
            | tr -s '[:space:]' ' ' \
            | sed 's/^ //;s/ $//' \
            > CApage_current.txt

      - name: Compare and Heartbeat
        id: check
        shell: bash
        run: |
          set -euo pipefail

          # 1. Heartbeat on every run
          echo "Last checked at: $(date -u)" > CAheartbeat.txt

          # 2. Hash comparison
          if [ -f CApage_previous.txt ]; then
            prev_hash=$(sha256sum CApage_previous.txt | cut -d' ' -f1)
          else
            prev_hash="none"
          fi

          current_hash=$(sha256sum CApage_current.txt | cut -d' ' -f1)

          if [ "${current_hash}" != "${prev_hash}" ]; then
            echo "CHANGED=true" >> "$GITHUB_ENV"
            mv CApage_current.txt CApage_previous.txt
          else
            echo "CHANGED=false" >> "$GITHUB_ENV"
          fi

      - name: Commit and Push (With Collision Protection)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add CAheartbeat.txt

          if [ "${FETCH_OK}" = "false" ]; then
            git add CApage_current.txt || true
            git commit -m "CA RHT: Fetch failed (Access Denied) â€” monitoring skipped"
          else
            if [ "${CHANGED}" = "true" ]; then
              git add CApage_previous.txt
              git commit -m "ALARM: CA Rural Health Transformation page changed"
            else
              git commit -m "CA RHT: No changes found"
            fi
          fi

          # COLLISION PROTECTION: Sync with other state updates before pushing
          git pull --rebase origin main
          git push
