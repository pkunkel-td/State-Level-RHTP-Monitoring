name: Monitor OK Rural Health Page

on:
  schedule:
    - cron: "0 * * * *" # Runs every hour
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      URL: "https://oklahoma.gov/health/rhtp.html"
      UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch and Wrap Page
        id: fetch
        shell: bash
        run: |
          set -euo pipefail
          # Using multiple mirrors to bypass potential bot-blocking
          MIRRORS=("https://r.jina.ai/${URL}" "https://www.textise.org/showtext.aspx?strURL=${URL}")
          FETCH_OK=false
          for MIRROR in "${MIRRORS[@]}"; do
            if curl -sL --fail --retry 3 -A "${UA}" "${MIRROR}" > raw.txt; then
              if ! grep -qiE "Access Denied|403 Forbidden" raw.txt; then
                FETCH_OK=true; break
              fi
            fi
          done

          if [ "${FETCH_OK}" = "true" ]; then
            echo "FETCH_OK=true" >> "$GITHUB_ENV"
            
            # NORMALIZATION FOR OKLAHOMA.GOV:
            # 1. Strips scripts and styles
            # 2. Removes HTML tags
            # 3. Strips specific Oklahoma.gov header/footer noise (Like "Published Time" or "Last Modified")
            # 4. Collapses whitespace and wraps at 80 chars
            cat raw.txt \
              | sed -E 's/<script[^>]*>.*<\/script>//gI' \
              | sed -E 's/<style[^>]*>.*<\/style>//gI' \
              | sed 's/<[^>]*>//g' \
              | sed -E 's/(Published Time|Last Modified|Updated): [^ ]+ [^ ]+ [^ ]+ [^ ]+ [^ ]+ [^ ]+//gI' \
              | tr -s '[:space:]' ' ' \
              | fmt -w 80 \
              | sed 's/^ //;s/ $//' \
              > OKpage_current.txt
          else
            echo "FETCH_OK=false" >> "$GITHUB_ENV"
          fi

      - name: Compare and Heartbeat
        run: |
          echo "Last checked: $(date -u)" > OKheartbeat.txt
          [ -f OKpage_previous.txt ] && prev=$(sha256sum OKpage_previous.txt | cut -d' ' -f1) || prev="none"
          curr=$(sha256sum OKpage_current.txt | cut -d' ' -f1)
          
          if [ "$curr" != "$prev" ]; then 
            echo "CHANGED=true" >> "$GITHUB_ENV"
            mv OKpage_current.txt OKpage_previous.txt
          else 
            echo "CHANGED=false" >> "$GITHUB_ENV"
          fi

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add OKheartbeat.txt
          if [ "${FETCH_OK}" = "true" ] && [ "${CHANGED}" = "true" ]; then 
            git add OKpage_previous.txt 
            git commit -m "ALARM: OK Rural Health Content Change"
          else 
            git commit -m "OK RHT: Heartbeat"
          fi
          git pull --rebase origin main
          git push
