name: Monitor RI Rural Health Page

on:
  schedule:
    - cron: "2 */8 * * *" # Runs at minute 2 of every 8th hour
  workflow_dispatch:      # Keep this so you can still run it manually

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      URL: "https://health.ri.gov/healthcare/rural-health-transformation-program"
      UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch and Wrap Page
        id: fetch
        shell: bash
        run: |
          set -euo pipefail

          MIRRORS=(
            "https://r.jina.ai/${URL}"
            "https://www.textise.org/showtext.aspx?strURL=${URL}"
          )

          is_blocked() {
            grep -qiE "Access Denied|403 Forbidden|Security Service|Please enable cookies|unusual traffic|blocked|You don't have permission" "$1"
          }

          FETCH_OK=false
          > raw.txt || true

          for MIRROR in "${MIRRORS[@]}"; do
            echo "Attempting mirror: ${MIRROR}"
            if curl -sL --fail --retry 3 -A "${UA}" -H "Referer: https://www.google.com/" "${MIRROR}" > raw.txt; then
              if ! is_blocked raw.txt; then
                FETCH_OK=true
                break
              fi
            fi
          done

          if [ "${FETCH_OK}" = "false" ]; then
            echo "FETCH_FAILED: Access Denied or mirrors unavailable" > RIpage_current.txt
            echo "FETCH_OK=false" >> "$GITHUB_ENV"
          else
            echo "FETCH_OK=true" >> "$GITHUB_ENV"
            
            # REINFORCED DE-NOISING logic added below:
            cat raw.txt \
              | sed -E 's/<script[^>]*>.*<\/script>//gI' \
              | sed -E 's/<style[^>]*>.*<\/style>//gI' \
              | sed 's/<[^>]*>//g' \
              # 1. Targets "Published Time", "Updated", "Reviewed", etc. and everything following on that line
              | sed -E 's/(Published|Updated|Last Modified|Page generated on|Session ID|Date|Reviewed):? [^ ]+ [^ ]+ [^ ]+ [^ ]+ [^ ]+ [^ ]+//gI' \
              # 2. Specifically strips Month DD, YYYY strings (e.g., January 20, 2026)
              | sed -E 's/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]* [0-9]{1,2},? 202[0-9]//gI' \
              # 3. Strips numerical dates (e.g., 01/20/2026 or 20-01-2026)
              | sed -E 's/[0-9]{1,2}(\/|-)[0-9]{1,2}(\/|-)202[0-9]//g' \
              | sed '/Textise/d' \
              | grep -vE '^[[:space:]]*[0-9]{1,2}\/[0-9]{1,2}\/[0-9]{2,4}[[:space:]]*$' \
              | tr -s '[:space:]' ' ' \
              | fmt -w 80 \
              | sed 's/^ //;s/ $//' \
              > RIpage_current.txt
          fi

      - name: Compare and Heartbeat
        id: check
        shell: bash
        run: |
          set -euo pipefail
          echo "Last checked at: $(date -u)" > RIheartbeat.txt
          
          [ -f RIpage_previous.txt ] && prev_hash=$(sha256sum RIpage_previous.txt | cut -d' ' -f1) || prev_hash="none"
          current_hash=$(sha256sum RIpage_current.txt | cut -d' ' -f1)

          if [ "${current_hash}" != "${prev_hash}" ]; then
            echo "CHANGED=true" >> "$GITHUB_ENV"
            mv RIpage_current.txt RIpage_previous.txt
          else
            echo "CHANGED=false" >> "$GITHUB_ENV"
          fi

      - name: Commit and Push (Collision Protection)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add RIheartbeat.txt

          if [ "${FETCH_OK}" = "false" ]; then
            git add RIpage_current.txt || true
            git commit -m "RI RHT: Fetch failed (Access Denied)"
          elif [ "${CHANGED}" = "true" ]; then
            git add RIpage_previous.txt
            git commit -m "ALARM: RI Content Change Detected"
          else
            git commit -m "RI RHT: Heartbeat (No functional changes)"
          fi

          git pull --rebase origin main
          git push
