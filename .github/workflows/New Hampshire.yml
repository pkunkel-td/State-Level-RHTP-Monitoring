name: Monitor NH Rural Health Transformation Page

on:
  schedule:
    - cron: "0 * * * *"   # Runs hourly
  workflow_dispatch:      # Manual trigger for testing

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Page via Proxy (IP Block Bypass)
        run: |
          URL="https://www.dhhs.nh.gov/programs-services/medicaid/rural-health-transformation-program"
          
          # We use Textise as a mirror because government firewalls rarely block it.
          # This routes the request through a different IP address.
          curl -sL "https://www.textise.org/showtext.aspx?strURL=$URL" > raw.html

          # 1. Check if the fetch actually worked
          if grep -qi "Access Denied\|403 Forbidden\|Security Service" raw.html; then
            echo "Direct block detected even through proxy. Skipping run."
            exit 0
          fi

          # 2. Normalize content
          # This strips HTML, Textise UI elements, and scripts to keep your hash clean.
          cat raw.html \
            | sed -n '/\[ Textise \]/,$p' \
            | sed -E 's/<script[^>]*>.*<\/script>//gI' \
            | sed -E 's/<style[^>]*>.*<\/style>//gI' \
            | sed 's/<[^>]*>//g' \
            | sed '/Textise/d' \
            | sed '/Options/d' \
            | tr -s '[:space:]' ' ' \
            | sed 's/^ //;s/ $//' \
            > NHpage_current.txt

      - name: Compare and Heartbeat
        id: check
        run: |
          # 1. Update heartbeat every run
          echo "Last checked at: $(date -u)" > NHheartbeat.txt

          # 2. Hash comparison (Your original logic)
          if [ -f NHpage_previous.txt ]; then
            prev_hash=$(sha256sum NHpage_previous.txt | cut -d' ' -f1)
          else
            prev_hash="none"
          fi

          current_hash=$(sha256sum NHpage_current.txt | cut -d' ' -f1)

          if [ "$current_hash" != "$prev_hash" ]; then
            echo "CHANGED=true" >> $GITHUB_ENV
            mv NHpage_current.txt NHpage_previous.txt
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add NHheartbeat.txt

          if [ "${{ env.CHANGED }}" == "true" ]; then
            git add NHpage_previous.txt
            git commit -m "ALARM: NH Rural Health Transformation page changed"
          else
            git commit -m "NH RHT: No changes found"
          fi

          git push
