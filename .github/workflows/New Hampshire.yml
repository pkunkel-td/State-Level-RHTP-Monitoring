name: Monitor NH Rural Health Transformation Page

on:
  schedule:
    - cron: "0 * * * *"   # Runs hourly
  workflow_dispatch:      # Manual trigger for testing

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Page Content (Two-Step Bypass)
        run: |
          URL="https://www.dhhs.nh.gov/programs-services/medicaid/rural-health-transformation-program"
          DOMAIN="https://www.dhhs.nh.gov"
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"

          # 1. Create a temporary cookie jar
          COOKIE_JAR=$(mktemp)

          # 2. Step 1: Visit the main domain to get a session cookie (Bypasses 403)
          curl -sL -A "$UA" -c "$COOKIE_JAR" "$DOMAIN" > /dev/null

          # 3. Step 2: Fetch the actual page using the cookies and a Referer
          curl -sL -b "$COOKIE_JAR" -A "$UA" \
            -H "Referer: $DOMAIN" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8" \
            -H "Accept-Language: en-US,en;q=0.5" \
            "$URL" > raw.html

          # 4. Clean up
          rm -f "$COOKIE_JAR"

          # 5. Normalize Content (Stripping tags/scripts to keep comparison clean)
          cat raw.html \
            | sed -E 's/<script[^>]*>.*<\/script>//gI' \
            | sed -E 's/<style[^>]*>.*<\/style>//gI' \
            | sed 's/<[^>]*>//g' \
            | tr -s '[:space:]' ' ' \
            | sed 's/^ //;s/ $//' \
            > NHpage_current.txt

      - name: Compare and Heartbeat
        id: check
        run: |
          # 1. Update heartbeat every run
          echo "Last checked at: $(date -u)" > NHheartbeat.txt

          # 2. Hash comparison
          if [ -f NHpage_previous.txt ]; then
            prev_hash=$(sha256sum NHpage_previous.txt | cut -d' ' -f1)
          else
            prev_hash="none"
          fi

          current_hash=$(sha256sum NHpage_current.txt | cut -d' ' -f1)

          if [ "$current_hash" != "$prev_hash" ]; then
            echo "CHANGED=true" >> $GITHUB_ENV
            mv NHpage_current.txt NHpage_previous.txt
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add NHheartbeat.txt

          if [ "${{ env.CHANGED }}" == "true" ]; then
            git add NHpage_previous.txt
            git commit -m "ALARM: NH Rural Health Transformation page changed"
          else
            git commit -m "NH RHT: No changes found"
          fi

          git push
